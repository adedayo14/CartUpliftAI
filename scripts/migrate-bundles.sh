#!/bin/bash

# ğŸš€ Bundle System - Database Migration Script
# Run this after code is deployed to Vercel

set -e  # Exit on error

echo "ğŸ—„ï¸  Migrating Neon Database via Vercel..."
echo ""

# Step 1: Pull Vercel environment variables
echo "ğŸ“¥ Step 1: Pulling Vercel environment variables..."
vercel env pull .env.vercel --yes

if [ ! -f .env.vercel ]; then
    echo "âŒ Error: Failed to pull .env.vercel"
    exit 1
fi

echo "âœ… Environment variables pulled"
echo ""

# Step 2: Load environment variables
echo "ğŸ”§ Step 2: Loading DATABASE_URL..."
export $(grep DATABASE_URL .env.vercel | xargs)

if [ -z "$DATABASE_URL" ]; then
    echo "âŒ Error: DATABASE_URL not found in .env.vercel"
    exit 1
fi

echo "âœ… DATABASE_URL loaded"
echo ""

# Step 3: Run Prisma migration
echo "ğŸ”„ Step 3: Running Prisma migration..."
npx prisma migrate deploy

echo "âœ… Migration complete"
echo ""

# Step 4: Generate Prisma Client
echo "ğŸ”¨ Step 4: Generating Prisma Client..."
npx prisma generate

echo "âœ… Prisma Client generated"
echo ""

# Step 5: Verify migration
echo "ğŸ” Step 5: Verifying migration..."
echo "Opening Prisma Studio to verify new columns..."
echo ""
echo "Check that Bundle table has these new columns:"
echo "  âœ“ assignedProducts"
echo "  âœ“ bundleStyle"
echo "  âœ“ selectMinQty"
echo "  âœ“ selectMaxQty"
echo "  âœ“ tierConfig"
echo "  âœ“ allowDeselect"
echo "  âœ“ mainProductId"
echo "  âœ“ hideIfNoML"
echo ""
echo "Check that BundleProduct table has:"
echo "  âœ“ isRemovable"
echo "  âœ“ isAnchor"
echo "  âœ“ tierPricing"
echo ""

read -p "Open Prisma Studio to verify? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    npx prisma studio
fi

echo ""
echo "ğŸ‰ Migration complete!"
echo ""
echo "Next steps:"
echo "1. Go to your app: https://cartuplift.vercel.app/admin/bundle-management-simple"
echo "2. Create a test bundle with one of the new styles (Grid/FBT/Tier)"
echo "3. Assign it to a product page"
echo "4. Test on your storefront"
echo ""
