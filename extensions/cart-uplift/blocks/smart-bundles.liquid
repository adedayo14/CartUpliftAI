{% comment %}
  Cart Uplift - Product Bundle Block  
  Version: 3.3.0 - Button colors & FBT price fix
{% endcomment %}

{%- comment -%} Load CSS and JS assets with cache busting {%- endcomment -%}
<link rel="stylesheet" href="{{ 'cart-bundles.css' | asset_url }}?v={{ 'now' | date: '%s' }}">
<script src="{{ 'cart-bundles.js' | asset_url }}?v={{ 'now' | date: '%s' }}" defer></script>

{%- comment -%} Preload bundle API data for faster rendering {%- endcomment -%}
{% if product %}
<link rel="preload" as="fetch" href="/apps/cart-uplift/api/bundles?product_id={{ product.id }}" crossorigin="anonymous">
{% endif %}

{%- liquid
  assign bundle_enabled = block.settings.bundle_enabled
  assign display_style = block.settings.display_style
  assign btn_bg = block.settings.button_bg_color | default: '#000000'
  assign btn_text = block.settings.button_text_color | default: '#FFFFFF'
  assign btn_border = block.settings.button_border_color | default: '#000000'
  assign btn_border_width = block.settings.button_border_width | default: 1
  assign btn_border_radius = block.settings.button_border_radius | default: 5
-%}

{% if bundle_enabled %}
  {%- comment -%} Inject custom button styles {%- endcomment -%}
  <style>
    .cartuplift-bundle-wrapper .bundle-add-btn,
    .cartuplift-bundle-wrapper .add-bundle-btn,
    .cartuplift-bundle-wrapper button.primary {
      background-color: {{ btn_bg }} !important;
      color: {{ btn_text }} !important;
      border: {{ btn_border_width }}px solid {{ btn_border }} !important;
      border-radius: {{ btn_border_radius }}px !important;
    }
    .cartuplift-bundle-wrapper .bundle-add-btn:hover,
    .cartuplift-bundle-wrapper .add-bundle-btn:hover,
    .cartuplift-bundle-wrapper button.primary:hover {
      opacity: 0.9;
    }
  </style>

  <div 
    class="cartuplift-bundle-wrapper"
    data-bundle-widget="true"
    data-product-id="{% if product %}{{ product.id }}{% endif %}"
    data-bundle-title="{{ block.settings.bundle_title | escape }}"
    data-bundle-priority="{{ block.settings.priority }}"
    data-display-style="{{ display_style }}"
  >
    {%- comment -%} Widget content loads instantly via JS - no loading spinner needed {%- endcomment -%}
  </div>
{% endif %}

{% schema %}
{
  "name": "Product Bundles",
  "target": "section",
  "templates": ["product", "collection"],
  "settings": [
    {
      "type": "paragraph",
      "content": "Create and manage bundles in the CartUplift admin dashboard. Use these settings to control the display and styling on your storefront."
    },
    {
      "type": "checkbox",
      "id": "bundle_enabled",
      "label": "Enable product bundles",
      "default": true,
      "info": "Show or hide bundle recommendations on this page"
    },
    {
      "type": "text",
      "id": "bundle_title",
      "label": "Section heading",
      "default": "Bundle & Save",
      "info": "Optional heading displayed above bundle recommendations"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "display_style",
      "label": "Display style",
      "options": [
        {
          "value": "clean",
          "label": "Horizontal (Recommended)"
        },
        {
          "value": "grid",
          "label": "Grid with checkboxes"
        },
        {
          "value": "list",
          "label": "Compact list"
        },
        {
          "value": "detailed",
          "label": "Detailed with variants"
        },
        {
          "value": "tier",
          "label": "Quantity tiers"
        }
      ],
      "default": "clean",
      "info": "Choose how bundles are displayed to customers"
    },
    {
      "type": "header",
      "content": "Button style"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Text color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "button_border_color",
      "label": "Border color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "button_border_width",
      "label": "Border width",
      "min": 0,
      "max": 5,
      "step": 1,
      "unit": "px",
      "default": 1,
      "info": "Set to 0 to remove border"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Corner radius",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 5,
      "info": "Controls the roundness of button corners"
    },
    {
      "type": "range",
      "id": "priority",
      "label": "Display priority",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 5,
      "info": "Lower numbers display first when multiple bundle blocks are present"
    }
  ]
}
{% endschema %}
